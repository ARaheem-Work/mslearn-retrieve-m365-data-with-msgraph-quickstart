<!DOCTYPE html>
<html lang="en">

<head>
    <title>JavaScript Microsoft Graph SPA</title>
    <link rel="icon" href="data:;base64,=">
</head>

<body>
    <main id="main-container" role="main" class="container">

        <script src="https://alcdn.msauth.net/browser/2.1.0/js/msal-browser.min.js"
            integrity="sha384-EmYPwkfj+VVmL1brMS1h6jUztl4QMS8Qq8xlZNgIT/luzg7MAzDVrRa2JxbNmk/e"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/@microsoft/microsoft-graph-client/lib/graph-js-sdk.js"></script>
        <script>
            (() => {
                const msalConfig = {
                    auth: {
                        clientId: '39b7055a-95f6-4d40-a87f-c66c543d81fe',//'<your client ID here>',
                        redirectUri: 'http://localhost:8080'
                    }
                };

                const msalRequest = { scopes: [ 'user.readx' ] }

                //login popup
                const msalClient = new msal.PublicClientApplication(msalConfig);
                async function signIn() {
                    const authResult = await msalClient.loginPopup(msalRequest);
                    sessionStorage.setItem('msalAccount', authResult.account.username);
                    // Get the user's profile from Graph
                    const user = await getUser();
                    // Save the profile in session storage
                    sessionStorage.setItem('graphUser', JSON.stringify(user));
                    showMe(user);
                }
                //Get token from Graph
                async function getToken() {
                    let account = sessionStorage.getItem('msalAccount');
                    if (!account) {
                        throw new Error(
                            'User info cleared from session. Please sign out and sign in again.');
                    }
                    try {
                        // First, attempt to get the token silently
                        const silentRequest = {
                            scopes: msalRequest.scopes,
                            account: msalClient.getAccountByUsername(account)
                        };

                        const silentResult = await msalClient.acquireTokenSilent(silentRequest);
                        return silentResult.accessToken;
                    } catch (silentError) {
                        // If silent requests fails with InteractionRequiredAuthError,
                        // attempt to get the token interactively
                        if (silentError instanceof msal.InteractionRequiredAuthError) {
                            const interactiveResult = await msalClient.acquireTokenPopup(msalRequest);
                            return interactiveResult.accessToken;
                        } else {
                            throw silentError;
                        }
                    }
                }
                // Create an authentication provider
                const authProvider = {
                    getAccessToken: async () => {
                        // Call getToken in auth.js
                        return await getToken();
                    }
                };
                // Initialize the Graph client
                const graphClient = MicrosoftGraph.Client.initWithMiddleware({ authProvider });
                //Get user info from Graph
                async function getUser() {
                    return await graphClient
                        .api('/me')
                        // Only get the fields used by the app
                        .select('id,displayName,mail,userPrincipalName')
                        .get();
                }
                //show my profile info
                function showMe(user) {
                    const mainContainer = document.getElementById('main-container');
                    if (user) {
                        // Welcome the user by name
                        var welcomeMessage = document.createElement('h4');
                        welcomeMessage.textContent = `Welcome ${user.displayName}!`;
                        mainContainer.innerHTML = '';
                        mainContainer.appendChild(welcomeMessage);
                    }
                    else {
                        // Show a sign in button 
                        var signInButton = document.createElement('button')
                        signInButton.innerHTML = "Click here to sign in";
                        signInButton.addEventListener("click", () => { signIn(); });
                        mainContainer.appendChild(signInButton);
                    }
                }
                showMe();
            })();

        </script>
</body>

</html>